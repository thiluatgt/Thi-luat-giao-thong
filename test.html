<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>KIá»‚M TRA LUáº¬T GIAO THÃ”NG ÄÆ¯á»œNG Bá»˜</title>
</head>

<body style="margin:0;font-family:Arial;background:#f4f6f8;">

<!-- ===== HEADER FIXED ===== -->
<div style="
position:fixed;
top:0;left:0;right:0;
background:#1d3557;
color:white;
padding:15px 25px;
display:flex;
justify-content:space-between;
align-items:center;
z-index:1000;
box-shadow:0 2px 10px rgba(0,0,0,0.4);
">

<div>
<b id="studentName"></b><br>
<span id="studentCode"></span>
</div>

<div style="font-size:20px;font-weight:bold;">
â± <span id="time">30:00</span>
</div>

</div>

<!-- ===== MAIN CONTENT ===== -->
<div style="max-width:900px;margin:120px auto 40px;padding:0 20px;">

<!-- QUESTION BOX -->
<div id="questionBox" style="
background:white;
padding:25px;
border-radius:10px;
min-height:200px;
box-shadow:0 5px 20px rgba(0,0,0,0.15);
font-size:16px;
"></div>

<!-- NAVIGATION -->
<div style="display:flex;justify-content:space-between;margin-top:20px;">
<button id="prevBtn" onclick="prevQuestion()" style="padding:10px 18px;">
â¬… CÃ¢u trÆ°á»›c
</button>

<button id="nextBtn" onclick="nextQuestion()" style="padding:10px 18px;">
CÃ¢u tiáº¿p theo â¡
</button>

<button id="submitBtn" onclick="submitExam()" style="
display:none;
padding:10px 22px;
background:#e63946;
color:white;
border:none;
border-radius:6px;
font-size:16px;
cursor:pointer;
">
ğŸ“¤ Ná»˜P BÃ€I
</button>
</div>

<!-- QUESTION MAP -->
<div id="map" style="
display:flex;
flex-wrap:wrap;
gap:8px;
justify-content:center;
margin-top:30px;
"></div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== LOGIN CHECK ===== */
const userType = localStorage.getItem("userType");
if (!userType) {
  alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p");
  window.location.href = "index.html";
}

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
  authDomain: "thi-luat-giao-thong.firebaseapp.com",
  projectId: "thi-luat-giao-thong"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== USER INFO ===== */
const studentCode = localStorage.getItem("studentCode") || "KHÃCH";
const studentName = localStorage.getItem("studentName") || "KhÃ¡ch";

document.getElementById("studentCode").innerText = "MÃ£: " + studentCode;
document.getElementById("studentName").innerText = "ğŸ‘¤ " + studentName;

/* ===== QUESTIONS (MáºªU) ===== */
const baseQuestions = [
  {
    q: "NgÆ°á»i Ä‘iá»u khiá»ƒn xe mÃ´ tÃ´ pháº£i Ä‘á»§ bao nhiÃªu tuá»•i?",
    a: ["16 tuá»•i", "18 tuá»•i", "20 tuá»•i", "21 tuá»•i"],
    c: 1
  },
  {
    q: "Biá»ƒn bÃ¡o hÃ¬nh trÃ²n viá»n Ä‘á» cÃ³ Ã½ nghÄ©a gÃ¬?",
    a: ["Chá»‰ dáº«n", "Cáº¥m", "Nguy hiá»ƒm", "Cáº£nh bÃ¡o"],
    c: 1
  }
];

// táº¡o Ä‘á»§ 30 cÃ¢u
const questions = [];
while (questions.length < 30) {
  questions.push(JSON.parse(JSON.stringify(baseQuestions[questions.length % 2])));
}

let current = 0;
const answers = new Array(30).fill(null);

/* ===== DOM ===== */
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");
const map = document.getElementById("map");
const timeEl = document.getElementById("time");

/* ===== RENDER QUESTION ===== */
function render() {
  const q = questions[current];
  let html = `<b>CÃ¢u ${current + 1}/30:</b> ${q.q}<br><br>`;

  q.a.forEach((ans, i) => {
    html += `
      <label style="display:block;margin-bottom:8px;">
        <input type="radio" name="ans"
          ${answers[current] === i ? "checked" : ""}
          onchange="answers[${current}] = ${i}; updateMap();">
        ${ans}
      </label>
    `;
  });

  document.getElementById("questionBox").innerHTML = html;

  prevBtn.style.display = current === 0 ? "none" : "inline-block";
  nextBtn.style.display = current === 29 ? "none" : "inline-block";
  submitBtn.style.display = current === 29 ? "inline-block" : "none";

  updateMap();
}

/* ===== QUESTION MAP ===== */
function updateMap() {
  map.innerHTML = "";
  answers.forEach((a, i) => {
    let color = "#ccc";
    if (i === current) color = "#e63946";
    else if (a !== null) color = "#457b9d";

    const box = document.createElement("div");
    box.style = `
      width:30px;height:30px;
      border-radius:4px;
      background:${color};
      color:white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:13px;
    `;
    box.innerText = i + 1;
    box.onclick = () => { current = i; render(); };
    map.appendChild(box);
  });
}

/* ===== NAV ===== */
function nextQuestion() {
  if (current < 29) { current++; render(); }
}
function prevQuestion() {
  if (current > 0) { current--; render(); }
}

/* ===== TIMER ===== */
let time = 30 * 60;
let submitted = false;

const timer = setInterval(() => {
  if (submitted) return;
  time--;
  const m = Math.floor(time / 60);
  const s = time % 60;
  timeEl.innerText =
    String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");

  if (time <= 0) submitExam();
}, 1000);

/* ===== SUBMIT EXAM ===== */
function submitExam() {
  if (submitted) return;
  submitted = true;
  clearInterval(timer);

  let correct = 0;
  questions.forEach((q, i) => {
    if (answers[i] === q.c) correct++;
  });

  const pass = correct >= 27;
  const today = new Date().toISOString().split("T")[0];

  db.collection("exam_logs").add({
    code: studentCode,
    score: correct,
    total: 30,
    pass: pass,
    date: today,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    alert(
      "Káº¾T QUáº¢\n" +
      "ÄÃºng: " + correct + "/30\n" +
      (pass ? "âœ… Äáº T" : "âŒ KHÃ”NG Äáº T")
    );
    window.location.href = "exam.html";
  });
}

render();
</script>

</body>
</html>
