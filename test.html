<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Kiá»ƒm tra luáº­t giao thÃ´ng</title>
</head>

<body style="font-family:Arial;background:#f4f6f8;margin:0;padding:0;">

<div style="max-width:900px;margin:auto;padding:20px;">

<h2 style="text-align:center;color:#1d3557;">
KIá»‚M TRA LUáº¬T GIAO THÃ”NG ÄÆ¯á»œNG Bá»˜
</h2>

<div style="
background:#fff;
padding:15px;
border-radius:8px;
margin-bottom:20px;
display:flex;
justify-content:space-between;
align-items:center;
">

<div>
<b>Há»c viÃªn:</b> <span id="studentName"></span><br>
<b>MÃ£:</b> <span id="studentCode"></span>
</div>

<div style="font-size:18px;color:red;">
â± Thá»i gian: <span id="time">30:00</span>
</div>

</div>

<form id="examForm"></form>

<button onclick="submitExam()" style="
width:100%;
padding:15px;
font-size:18px;
background:#e63946;
color:white;
border:none;
border-radius:8px;
cursor:pointer;
margin-top:20px;
">
ğŸ“¤ Ná»˜P BÃ€I
</button>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
  authDomain: "thi-luat-giao-thong.firebaseapp.com",
  projectId: "thi-luat-giao-thong"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== LOGIN CHECK ===== */
const userType = localStorage.getItem("userType");
if (!userType) {
  alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p");
  window.location.href = "index.html";
}

const studentCode = localStorage.getItem("studentCode") || "KHÃCH";
const studentName = localStorage.getItem("studentName") || "KhÃ¡ch";

document.getElementById("studentCode").innerText = studentCode;
document.getElementById("studentName").innerText = studentName;

/* ===== DANH SÃCH CÃ‚U Há»I MáºªU ===== */
const questions = [
  {
    q: "NgÆ°á»i Ä‘iá»u khiá»ƒn xe mÃ´ tÃ´ pháº£i Ä‘á»§ bao nhiÃªu tuá»•i?",
    a: ["16 tuá»•i", "18 tuá»•i", "20 tuá»•i", "21 tuá»•i"],
    correct: 1
  },
  {
    q: "Biá»ƒn bÃ¡o hÃ¬nh trÃ²n viá»n Ä‘á» cÃ³ Ã½ nghÄ©a gÃ¬?",
    a: ["Chá»‰ dáº«n", "Cáº£nh bÃ¡o", "Cáº¥m", "Nguy hiá»ƒm"],
    correct: 2
  }
];

// NhÃ¢n báº£n thÃ nh 30 cÃ¢u
while (questions.length < 30) {
  questions.push(JSON.parse(JSON.stringify(questions[questions.length % 2])));
}

/* ===== HIá»‚N THá»Š CÃ‚U Há»I ===== */
const form = document.getElementById("examForm");

questions.forEach((item, index) => {
  const div = document.createElement("div");
  div.style = "background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;";

  let html = `<b>CÃ¢u ${index+1}:</b> ${item.q}<br><br>`;
  item.a.forEach((ans, i) => {
    html += `
      <label>
        <input type="radio" name="q${index}" value="${i}">
        ${ans}
      </label><br>
    `;
  });

  div.innerHTML = html;
  form.appendChild(div);
});

/* ===== Äáº¾M GIá»œ ===== */
let time = 30 * 60;
setInterval(() => {
  time--;
  if (time <= 0) submitExam();
  const m = Math.floor(time / 60);
  const s = time % 60;
  document.getElementById("time").innerText =
    String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}, 1000);

/* ===== Ná»˜P BÃ€I & GHI LOG ===== */
function submitExam() {
  let correct = 0;

  questions.forEach((q, i) => {
    const ans = document.querySelector(`input[name="q${i}"]:checked`);
    if (ans && Number(ans.value) === q.correct) correct++;
  });

  const pass = correct >= 27;
  const today = new Date().toISOString().split("T")[0];

  db.collection("exam_logs").add({
    code: studentCode,
    score: correct,
    total: 30,
    pass: pass,
    date: today,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    alert(
      "Káº¾T QUáº¢:\n" +
      "ÄÃºng: " + correct + "/30\n" +
      (pass ? "âœ… Äáº T" : "âŒ KHÃ”NG Äáº T")
    );
    window.location.href = "exam.html";
  });
}
</script>

</body>
</html>
