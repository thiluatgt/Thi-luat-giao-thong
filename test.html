<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>KI·ªÇM TRA LU·∫¨T GIAO TH√îNG</title>
</head>

<body style="margin:0;font-family:Arial;background:#eef2f7;">

<!-- ===== HEADER ===== -->
<div style="
position:fixed;
top:0;left:0;right:0;
background:#a8dadc;
padding:18px 60px;
display:flex;
justify-content:space-between;
align-items:center;
z-index:1000;
box-shadow:0 2px 10px rgba(0,0,0,0.3);
">

<!-- LEFT SPACER -->
<div style="width:200px;"></div>

<!-- STUDENT INFO (CENTER) -->
<div style="text-align:center;">
  <div id="studentName" style="font-size:20px;font-weight:bold;"></div>
  <div id="studentInfo" style="font-size:15px;margin-top:4px;"></div>
</div>

<!-- TIMER (RIGHT) -->
<div style="font-size:34px;font-weight:bold;color:#1d3557;">
‚è± <span id="time">30:00</span>
</div>

</div>

<!-- ===== MAIN ===== -->
<div style="max-width:900px;margin:140px auto 40px;padding:0 20px;">

<div id="questionBox" style="
background:white;
padding:30px;
border-radius:12px;
min-height:220px;
box-shadow:0 6px 25px rgba(0,0,0,0.15);
font-size:17px;
"></div>

<div style="
display:flex;
justify-content:center;
gap:30px;
margin-top:25px;
">

<button id="prevBtn" onclick="prevQuestion()" style="
padding:16px 34px;
font-size:18px;
background:#457b9d;
color:white;
border:none;
border-radius:8px;
cursor:pointer;
display:none;
">
‚¨Ö C√¢u tr∆∞·ªõc
</button>

<button id="nextBtn" onclick="nextQuestion()" style="
padding:16px 34px;
font-size:18px;
background:#1d3557;
color:white;
border:none;
border-radius:8px;
cursor:pointer;
">
C√¢u ti·∫øp theo ‚û°
</button>

<button id="submitBtn" onclick="submitExam()" style="
display:none;
padding:16px 36px;
font-size:19px;
background:#e63946;
color:white;
border:none;
border-radius:8px;
cursor:pointer;
">
üì§ N·ªòP B√ÄI
</button>

</div>

<div id="map" style="
display:grid;
grid-template-columns:repeat(15, 1fr);
gap:8px;
margin-top:35px;
justify-items:center;
"></div>

<div style="
margin-top:20px;
display:flex;
justify-content:center;
gap:25px;
font-size:14px;
">
<div><span style="display:inline-block;width:18px;height:18px;background:#fff;border:1px solid #999;"></span> Ch∆∞a l√†m</div>
<div><span style="display:inline-block;width:18px;height:18px;background:#457b9d;"></span> ƒê√£ l√†m</div>
<div><span style="display:inline-block;width:18px;height:18px;background:#e63946;"></span> C√¢u hi·ªán t·∫°i</div>
</div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== LOGIN ===== */
if (!localStorage.getItem("userType")) {
  alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");
  window.location.href = "index.html";
}

/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
  authDomain: "thi-luat-giao-thong.firebaseapp.com",
  projectId: "thi-luat-giao-thong"
});
const db = firebase.firestore();

/* ===== USER ===== */
const name = localStorage.getItem("studentName") || "Kh√°ch";
const code = localStorage.getItem("studentCode") || "---";
const unit = localStorage.getItem("studentUnit") || "Ch∆∞a c·∫≠p nh·∫≠t";

studentName.innerText = name;
studentInfo.innerText = `M√£ HV: ${code} ‚Äì ƒê∆°n v·ªã: ${unit}`;

/* ===== QUESTIONS ===== */
const base = [
 {q:"Ng∆∞·ªùi ƒëi·ªÅu khi·ªÉn xe m√¥ t√¥ ph·∫£i ƒë·ªß bao nhi√™u tu·ªïi?",a:["16","18","20","21"],c:1},
 {q:"Bi·ªÉn b√°o tr√≤n vi·ªÅn ƒë·ªè l√† g√¨?",a:["Ch·ªâ d·∫´n","C·∫•m","Nguy hi·ªÉm","C·∫£nh b√°o"],c:1}
];

const questions=[];
while(questions.length<30){
 questions.push(JSON.parse(JSON.stringify(base[questions.length%2])));
}

let current=0;
const answers=new Array(30).fill(null);

/* ===== RENDER ===== */
function render(){
 const q=questions[current];
 let html=`<b>C√¢u ${current+1}/30:</b> ${q.q}<br><br>`;
 q.a.forEach((x,i)=>{
  html+=`
  <label style="display:block;margin-bottom:10px;">
   <input type="radio" name="ans"
    ${answers[current]==i?"checked":""}
    onchange="answers[${current}]=${i};updateMap()">
   ${x}
  </label>`;
 });
 questionBox.innerHTML=html;

 prevBtn.style.display = current>=1 ? "inline-block" : "none";
 nextBtn.style.display = current<29 ? "inline-block" : "none";
 submitBtn.style.display = current==29 ? "inline-block" : "none";

 updateMap();
}

/* ===== MAP ===== */
function updateMap(){
 map.innerHTML="";
 answers.forEach((a,i)=>{
  let bg="#fff", color="#000";
  if(i==current){ bg="#e63946"; color="white"; }
  else if(a!==null){ bg="#457b9d"; color="white"; }

  const d=document.createElement("div");
  d.style=`
   width:34px;height:34px;
   border-radius:6px;
   border:1px solid #999;
   background:${bg};
   color:${color};
   display:flex;
   align-items:center;
   justify-content:center;
   cursor:pointer;
   font-size:14px;
  `;
  d.innerText=i+1;
  d.onclick=()=>{current=i;render();}
  map.appendChild(d);
 });
}

/* ===== NAV ===== */
function nextQuestion(){ if(current<29){current++;render();}}
function prevQuestion(){ if(current>0){current--;render();}}

/* ===== TIMER ===== */
let t=30*60, done=false;
const timer=setInterval(()=>{
 if(done)return;
 t--;
 time.innerText=
  String(Math.floor(t/60)).padStart(2,"0")+":"+
  String(t%60).padStart(2,"0");
 if(t<=0) submitExam();
},1000);

/* ===== SUBMIT ===== */
function submitExam(){
 if(done)return;
 done=true; clearInterval(timer);
 let correct=0;
 questions.forEach((q,i)=>{if(answers[i]==q.c)correct++;});
 db.collection("exam_logs").add({
  code, unit,
  score:correct,
  total:30,
  pass:correct>=27,
  timestamp:firebase.firestore.FieldValue.serverTimestamp()
 }).then(()=>{
  alert(`K·∫øt qu·∫£: ${correct}/30`);
  location.href="exam.html";
 });
}

render();
</script>

</body>
</html>
