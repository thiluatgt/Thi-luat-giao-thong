<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>H·ªÜ TH·ªêNG KI·ªÇM TRA LU·∫¨T GIAO TH√îNG ƒê∆Ø·ªúNG B·ªò TR·ª∞C TUY·∫æN</title>

<style>
body{
 margin:0;
 font-family:Arial, Helvetica, sans-serif;
 background:#eef2f6;
}

/* ===== HEADER ===== */
#header{
 position:fixed;
 top:0;left:0;right:0;
 height:90px;
 background:#1d3557;
 color:white;
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:0 40px;
 z-index:1000;
}

#studentBox{
 text-align:center;
 line-height:1.4;
}

#studentBox b{
 font-size:18px;
}

#studentBox span{
 font-size:14px;
}

#timer{
 font-size:30px;
 font-weight:bold;
}

/* ===== MAIN ===== */
#main{
 max-width:1000px;
 margin:120px auto 40px;
 padding:0 20px;
 display:flex;
 gap:20px;
}

/* ===== QUESTION ===== */
#content{
 flex:3;
 background:white;
 padding:30px;
 border-radius:10px;
 box-shadow:0 5px 20px rgba(0,0,0,0.15);
 min-height:420px;
}

.answer{
 display:block;
 margin-bottom:12px;
 padding:10px;
 border-radius:6px;
 cursor:pointer;
 background:#f4f6f8;
}

/* ===== NAV ===== */
#nav{
 display:flex;
 justify-content:center;
 gap:30px;
 margin-top:25px;
}

.navBtn{
 font-size:18px;
 padding:14px 28px;
 border:none;
 border-radius:8px;
 cursor:pointer;
}

#prevBtn{background:#457b9d;color:white;}
#nextBtn{background:#1d3557;color:white;}
#submitBtn{background:#e63946;color:white;display:none;}

/* ===== MAP ===== */
#side{
 flex:1;
}

#map{
 display:grid;
 grid-template-columns:repeat(5,1fr);
 gap:6px;
}

.mapItem{
 width:32px;
 height:32px;
 border-radius:5px;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:13px;
 cursor:pointer;
 border:1px solid #ccc;
}

.legend{
 margin-top:15px;
 font-size:13px;
}
.legend div{margin-bottom:4px;}
</style>
</head>

<body>

<!-- ===== HEADER ===== -->
<div id="header">
 <div style="width:150px;"></div>

 <div id="studentBox">
  <b id="studentName"></b><br>
  <span id="studentInfo"></span>
 </div>

 <div id="timer">30:00</div>
</div>

<!-- ===== MAIN ===== -->
<div id="main">

 <!-- QUESTION -->
 <div id="content">
  <div id="questionBox"></div>

  <div id="nav">
   <button id="prevBtn" class="navBtn" onclick="prevQuestion()">‚¨Ö C√¢u tr∆∞·ªõc</button>
   <button id="nextBtn" class="navBtn" onclick="nextQuestion()">C√¢u ti·∫øp theo ‚û°</button>
   <button id="submitBtn" class="navBtn" onclick="submitExam()">üì§ N·ªòP B√ÄI</button>
  </div>
 </div>

 <!-- SIDE -->
 <div id="side">
  <div id="map"></div>

  <div class="legend">
   <div>‚¨ú Ch∆∞a l√†m</div>
   <div style="color:#457b9d;">üü¶ ƒê√£ l√†m</div>
   <div style="color:#e63946;">üü• C√¢u hi·ªán t·∫°i</div>
  </div>
 </div>

</div>

<!-- ===== FIREBASE ===== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== LOGIN CHECK ===== */
if(!localStorage.getItem("userType")){
 alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");
 location.href="index.html";
}

/* ===== FIREBASE ===== */
firebase.initializeApp({
 apiKey: "AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
 authDomain: "thi-luat-giao-thong.firebaseapp.com",
 projectId: "thi-luat-giao-thong"
});
const db = firebase.firestore();

/* ===== USER ===== */
const studentCode = localStorage.getItem("studentCode") || "KH√ÅCH";
const studentName = localStorage.getItem("studentName") || "Kh√°ch";
const unit = localStorage.getItem("unit") || "T·ª± do";

studentNameEl.innerText = "üë§ " + studentName;
studentInfo.innerText = "M√£ HV: " + studentCode + " | ƒê∆°n v·ªã: " + unit;

/* ===== QUESTIONS (C√ì ·∫¢NH) ===== */
const base = [
 {
  q:"Bi·ªÉn b√°o n√†o l√† bi·ªÉn c·∫•m ƒëi ng∆∞·ª£c chi·ªÅu?",
  img:"https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Vietnam_road_sign_P102.svg/200px-Vietnam_road_sign_P102.svg.png",
  a:["Bi·ªÉn A","Bi·ªÉn B","Bi·ªÉn C","Bi·ªÉn D"],
  c:0
 },
 {
  q:"Ng∆∞·ªùi ƒëi·ªÅu khi·ªÉn xe m√¥ t√¥ ph·∫£i ƒë·ªß bao nhi√™u tu·ªïi?",
  a:["16","18","20","21"],
  c:1
 }
];

const questions=[];
while(questions.length<30){
 questions.push(JSON.parse(JSON.stringify(base[questions.length%base.length])));
}

let current=0;
const answers=new Array(30).fill(null);

/* ===== RENDER ===== */
function render(){
 const q=questions[current];
 let html=`
 <b>C√¢u ${current+1}/30:</b><br><br>
 <div>${q.q}</div>
 `;

 if(q.img){
  html+=`
  <div style="text-align:center;margin:15px 0;">
   <img src="${q.img}" style="max-width:100%;max-height:260px;border-radius:8px;">
  </div>`;
 }

 q.a.forEach((x,i)=>{
  html+=`
  <label class="answer">
   <input type="radio" name="ans"
    ${answers[current]==i?"checked":""}
    onchange="answers[${current}]=${i};updateMap()">
   ${x}
  </label>`;
 });

 questionBox.innerHTML=html;

 prevBtn.style.display=current>=1?"inline-block":"none";
 nextBtn.style.display=current<29?"inline-block":"none";
 submitBtn.style.display=current==29?"inline-block":"none";

 updateMap();
}

/* ===== MAP ===== */
function updateMap(){
 map.innerHTML="";
 answers.forEach((a,i)=>{
  let bg="#fff";
  if(i==current) bg="#e63946";
  else if(a!==null) bg="#457b9d";

  const d=document.createElement("div");
  d.className="mapItem";
  d.style.background=bg;
  d.style.color=bg=="#fff"?"#000":"#fff";
  d.innerText=i+1;
  d.onclick=()=>{current=i;render();}
  map.appendChild(d);
 });
}

/* ===== NAV ===== */
function nextQuestion(){current++;render();}
function prevQuestion(){current--;render();}

/* ===== TIMER ===== */
let t=30*60,submitted=false;
const timer=setInterval(()=>{
 if(submitted)return;
 t--;
 timer.innerText=
 String(Math.floor(t/60)).padStart(2,"0")+":"+
 String(t%60).padStart(2,"0");
 if(t<=0)submitExam();
},1000);

/* ===== SUBMIT ===== */
function submitExam(){
 if(submitted)return;
 submitted=true;
 clearInterval(timer);

 let correct=0;
 questions.forEach((q,i)=>{if(answers[i]==q.c)correct++;});
 const pass=correct>=27;

 db.collection("exam_logs").add({
  code:studentCode,
  score:correct,
  total:30,
  pass:pass,
  timestamp:firebase.firestore.FieldValue.serverTimestamp()
 }).then(()=>{
  alert(`K·∫æT QU·∫¢\n${correct}/30\n${pass?"ƒê·∫†T":"KH√îNG ƒê·∫†T"}`);
  location.href="exam.html";
 });
}

render();
</script>

</body>
</html>
