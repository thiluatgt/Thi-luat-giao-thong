<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>H·ªÜ TH·ªêNG KI·ªÇM TRA LU·∫¨T GIAO TH√îNG ƒê∆Ø·ªúNG B·ªò TR·ª∞C TUY·∫æN</title>

<style>
body{
 margin:0;
 font-family:Arial;
 background:#eef2f6;
}
#header{
 position:fixed;
 top:0;left:0;right:0;
 height:90px;
 background:#1d3557;
 color:white;
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:0 40px;
 z-index:1000;
}
#studentBox{text-align:center;}
#timer{font-size:30px;font-weight:bold;}
#main{
 max-width:1100px;
 margin:120px auto 40px;
 padding:0 20px;
 display:flex;
 gap:25px;
}
#content{
 flex:3;
 background:white;
 padding:30px;
 border-radius:12px;
 min-height:520px;
 box-shadow:0 5px 20px rgba(0,0,0,0.15);
}
#side{
 flex:1;
 background:white;
 padding:15px;
 border-radius:12px;
 box-shadow:0 5px 20px rgba(0,0,0,0.15);
}
.answer{
 display:block;
 margin-bottom:10px;
 padding:10px;
 border-radius:6px;
 background:#f4f6f8;
 cursor:pointer;
}
#map{
 display:grid;
 grid-template-columns:repeat(5,1fr);
 gap:8px;
}
.mapItem{
 width:34px;height:34px;
 border-radius:6px;
 display:flex;
 align-items:center;
 justify-content:center;
 cursor:pointer;
 border:1px solid #ccc;
}
#sideNav{
 margin-top:20px;
 display:flex;
 flex-direction:column;
 gap:12px;
}
.sideBtn{
 padding:12px;
 font-size:16px;
 border:none;
 border-radius:8px;
 cursor:pointer;
}
#prevBtn{background:#457b9d;color:white;}
#nextBtn{background:#1d3557;color:white;}
#submitBtn{background:#e63946;color:white;display:none;}
/* ===== SELECT SET ===== */
#setBox{
 max-width:600px;
 margin:160px auto;
 background:white;
 padding:30px;
 border-radius:12px;
 box-shadow:0 5px 20px rgba(0,0,0,0.2);
}
.setItem{
 border:1px solid #ccc;
 padding:15px;
 border-radius:8px;
 margin-bottom:15px;
 cursor:pointer;
}
.setItem:hover{background:#f1f5f9;}
</style>
</head>

<body>

<div id="header">
 <div></div>
 <div id="studentBox">
  <b id="studentName"></b><br>
  <span id="studentInfo"></span>
 </div>
 <div id="timer">30:00</div>
</div>

<!-- ===== CH·ªåN B·ªò ƒê·ªÄ ===== -->
<div id="setBox">
 <h2>üìö CH·ªåN B·ªò C√ÇU H·ªéI</h2>
 <div id="setList"></div>
</div>

<!-- ===== MAIN EXAM ===== -->
<div id="main" style="display:none;">
 <div id="content">
  <div id="questionBox"></div>
 </div>

 <div id="side">
  <div id="map"></div>

  <div id="sideNav">
   <button id="prevBtn" class="sideBtn" onclick="prevQuestion()">‚¨Ö C√¢u tr∆∞·ªõc</button>
   <button id="nextBtn" class="sideBtn" onclick="nextQuestion()">C√¢u ti·∫øp theo ‚û°</button>
   <button id="submitBtn" class="sideBtn" onclick="submitExam()">üì§ N·ªòP B√ÄI</button>
  </div>
 </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
 authDomain:"thi-luat-giao-thong.firebaseapp.com",
 projectId:"thi-luat-giao-thong"
});
const db=firebase.firestore();

/* USER */
const studentCode=localStorage.getItem("studentCode")||"KH√ÅCH";
const studentName=localStorage.getItem("studentName")||"Kh√°ch";
const unit=localStorage.getItem("unit")||"T·ª± do";
studentName.innerText="üë§ "+studentName;
studentInfo.innerText="M√£ HV: "+studentCode+" | "+unit;

/* ===== LOAD SETS ===== */
db.collection("question_sets").where("active","==",true).get()
.then(snap=>{
 snap.forEach(doc=>{
  const s=doc.data();
  const div=document.createElement("div");
  div.className="setItem";
  div.innerHTML=`<b>${s.name}</b><br><small>${s.description}</small>`;
  div.onclick=()=>selectSet(s.code);
  setList.appendChild(div);
 });
});

/* ===== EXAM ===== */
let questions=[],answers=[],current=0;

function selectSet(code){
 document.getElementById("setBox").style.display="none";
 document.getElementById("main").style.display="flex";

 db.collection("questions")
  .where("active","==",true)
  .where("setCode","==",code)
  .get()
  .then(snap=>{
   if(snap.size<30){
    alert("B·ªô ƒë·ªÅ ch∆∞a ƒë·ªß 30 c√¢u");
    location.reload();
    return;
   }
   let temp=[];
   snap.forEach(d=>{
    const q=d.data();
    temp.push({
     q:q.question,
     img:q.image||"",
     a:q.answers,
     c:q.correct
    });
   });
   temp.sort(()=>Math.random()-0.5);
   questions=temp.slice(0,30);
   answers=new Array(30).fill(null);
   render();
  });
}

/* ===== RENDER ===== */
function render(){
 const q=questions[current];
 let html=`<b>C√¢u ${current+1}/30:</b><br><br>${q.q}`;
 if(q.img){
  html+=`<div style="text-align:center;margin:15px 0;">
  <img src="${q.img}" style="max-width:100%;max-height:260px;"></div>`;
 }
 q.a.forEach((x,i)=>{
  html+=`<label class="answer">
   <input type="radio" name="ans"
    ${answers[current]==i?"checked":""}
    onchange="answers[${current}]=${i};updateMap()">
   ${x}
  </label>`;
 });
 questionBox.innerHTML=html;
 prevBtn.style.display=current>0?"block":"none";
 nextBtn.style.display=current<29?"block":"none";
 submitBtn.style.display=current==29?"block":"none";
 updateMap();
}

function updateMap(){
 map.innerHTML="";
 answers.forEach((a,i)=>{
  let bg="#fff";
  if(i==current) bg="#e63946";
  else if(a!==null) bg="#457b9d";
  const d=document.createElement("div");
  d.className="mapItem";
  d.style.background=bg;
  d.style.color=bg=="#fff"?"#000":"#fff";
  d.innerText=i+1;
  d.onclick=()=>{current=i;render();}
  map.appendChild(d);
 });
}
function nextQuestion(){current++;render();}
function prevQuestion(){current--;render();}
</script>

</body>
</html>
