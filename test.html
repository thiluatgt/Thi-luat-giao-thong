<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>H·ªÜ TH·ªêNG KI·ªÇM TRA LU·∫¨T GIAO TH√îNG ƒê∆Ø·ªúNG B·ªò TR·ª∞C TUY·∫æN</title>

<style>
body{
 margin:0;
 font-family:Arial, Helvetica, sans-serif;
 background:#eef2f6;
}

/* ===== HEADER ===== */
#header{
 position:fixed;
 top:0;left:0;right:0;
 height:90px;
 background:#1d3557;
 color:white;
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:0 40px;
 z-index:1000;
}

#studentBox{
 text-align:center;
 line-height:1.4;
}

#studentBox b{
 font-size:18px;
 display:block;
}

#studentBox span{
 font-size:14px;
}

#timer{
 font-size:32px;
 font-weight:bold;
}

/* ===== MAIN ===== */
#main{
 max-width:1100px;
 margin:120px auto 40px;
 padding:0 20px;
 display:flex;
 gap:25px;
}

/* ===== QUESTION ===== */
#content{
 flex:3;
 background:white;
 padding:30px;
 border-radius:12px;
 box-shadow:0 5px 20px rgba(0,0,0,0.15);
 min-height:520px;
}

/* ANSWER */
.answer{
 display:block;
 margin-bottom:12px;
 padding:10px;
 border-radius:6px;
 cursor:pointer;
 background:#f4f6f8;
}

/* ===== SIDE ===== */
#side{
 flex:1;
 background:#ffffff;
 padding:15px;
 border-radius:12px;
 box-shadow:0 5px 20px rgba(0,0,0,0.15);
}

/* MAP */
#map{
 display:grid;
 grid-template-columns:repeat(5,1fr);
 gap:8px;
}

.mapItem{
 width:34px;
 height:34px;
 border-radius:6px;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:13px;
 cursor:pointer;
 border:1px solid #ccc;
}

/* NAV IN SIDE */
#sideNav{
 display:flex;
 flex-direction:column;
 gap:12px;
 margin-top:20px;
}

.sideBtn{
 font-size:16px;
 padding:12px;
 border:none;
 border-radius:8px;
 cursor:pointer;
 width:100%;
}

#prevBtn{background:#457b9d;color:white;}
#nextBtn{background:#1d3557;color:white;}
#submitBtn{background:#e63946;color:white;display:none;}

/* LEGEND */
.legend{
 margin-top:15px;
 font-size:13px;
}
.legend div{margin-bottom:4px;}
</style>
</head>

<body>

<!-- ===== HEADER ===== -->
<div id="header">
 <div style="width:160px;"></div>

 <div id="studentBox">
  <b id="studentName"></b>
  <span id="studentInfo"></span>
 </div>

 <div id="timer">30:00</div>
</div>

<!-- ===== MAIN ===== -->
<div id="main">

 <!-- QUESTION CONTENT -->
 <div id="content">
  <div id="questionBox"></div>
 </div>

 <!-- SIDE PANEL -->
 <div id="side">

  <div id="map"></div>

  <div class="legend">
   <div>‚¨ú Ch∆∞a l√†m</div>
   <div style="color:#457b9d;">üü¶ ƒê√£ l√†m</div>
   <div style="color:#e63946;">üü• C√¢u hi·ªán t·∫°i</div>
  </div>

  <!-- NAVIGATION -->
  <div id="sideNav">
   <button id="prevBtn" class="sideBtn" onclick="prevQuestion()">‚¨Ö C√¢u tr∆∞·ªõc</button>
   <button id="nextBtn" class="sideBtn" onclick="nextQuestion()">C√¢u ti·∫øp theo ‚û°</button>
   <button id="submitBtn" class="sideBtn" onclick="submitExam()">üì§ N·ªòP B√ÄI</button>
  </div>

 </div>

</div>

<!-- ===== FIREBASE ===== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== LOGIN CHECK ===== */
if(!localStorage.getItem("userType")){
 alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");
 location.href="index.html";
}

/* ===== FIREBASE ===== */
firebase.initializeApp({
 apiKey: "AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
 authDomain: "thi-luat-giao-thong.firebaseapp.com",
 projectId: "thi-luat-giao-thong"
});
const db = firebase.firestore();

/* ===== USER ===== */
const studentCode = localStorage.getItem("studentCode") || "KH√ÅCH";
const studentName = localStorage.getItem("studentName") || "Kh√°ch";
const unit = localStorage.getItem("unit") || "T·ª± do";

studentName.innerText = "üë§ " + studentName;
studentInfo.innerText = "M√£ HV: " + studentCode + " | ƒê∆°n v·ªã: " + unit;

/* ===== QUESTIONS ===== */
let questions = [];
let current = 0;
const answers = new Array(30).fill(null);

/* LOAD QUESTIONS */
db.collection("questions")
 .where("active","==",true)
 .get()
 .then(snap=>{
  if(snap.size < 30){
   alert("‚ö†Ô∏è Ch∆∞a ƒë·ªß 30 c√¢u h·ªèi");
   return;
  }
  let temp=[];
  snap.forEach(doc=>{
   const d=doc.data();
   temp.push({
    q:d.question,
    img:d.image||"",
    a:d.answers,
    c:d.correct
   });
  });
  temp.sort(()=>Math.random()-0.5);
  questions=temp.slice(0,30);
  render();
 });

/* ===== RENDER ===== */
function render(){
 const q=questions[current];
 let html=`
 <b>C√¢u ${current+1}/30:</b><br><br>
 <div>${q.q}</div>
 `;
 if(q.img){
  html+=`
  <div style="text-align:center;margin:15px 0;">
   <img src="${q.img}" style="max-width:100%;max-height:280px;border-radius:8px;">
  </div>`;
 }
 q.a.forEach((x,i)=>{
  html+=`
  <label class="answer">
   <input type="radio" name="ans"
    ${answers[current]==i?"checked":""}
    onchange="answers[${current}]=${i};updateMap()">
   ${x}
  </label>`;
 });
 questionBox.innerHTML=html;

 prevBtn.style.display=current>=1?"block":"none";
 nextBtn.style.display=current<29?"block":"none";
 submitBtn.style.display=current==29?"block":"none";

 updateMap();
}

/* ===== MAP ===== */
function updateMap(){
 map.innerHTML="";
 answers.forEach((a,i)=>{
  let bg="#fff";
  if(i==current) bg="#e63946";
  else if(a!==null) bg="#457b9d";

  const d=document.createElement("div");
  d.className="mapItem";
  d.style.background=bg;
  d.style.color=bg=="#fff"?"#000":"#fff";
  d.innerText=i+1;
  d.onclick=()=>{current=i;render();}
  map.appendChild(d);
 });
}

/* NAV */
function nextQuestion(){current++;render();}
function prevQuestion(){current--;render();}

/* ===== TIMER ===== */
let t=30*60, submitted=false;
const clock=setInterval(()=>{
 if(submitted)return;
 t--;
 timer.innerText=
  String(Math.floor(t/60)).padStart(2,"0")+":"+
  String(t%60).padStart(2,"0");
 if(t<=0) submitExam();
},1000);

/* ===== SUBMIT ===== */
function submitExam(){
 if(submitted)return;
 submitted=true;
 clearInterval(clock);

 let correct=0;
 questions.forEach((q,i)=>{if(answers[i]==q.c)correct++;});
 const pass=correct>=27;

 db.collection("exam_logs").add({
  code:studentCode,
  score:correct,
  total:30,
  pass:pass,
  timestamp:firebase.firestore.FieldValue.serverTimestamp()
 }).then(()=>{
  alert(`K·∫æT QU·∫¢\n${correct}/30\n${pass?"‚úÖ ƒê·∫†T":"‚ùå KH√îNG ƒê·∫†T"}`);
  location.href="exam.html";
 });
}
</script>

</body>
</html>
