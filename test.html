<script>
/* ===== LOGIN CHECK ===== */
const userType = localStorage.getItem("userType");
if (!userType) {
  alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p");
  window.location.href = "index.html";
}

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
  authDomain: "thi-luat-giao-thong.firebaseapp.com",
  projectId: "thi-luat-giao-thong"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== USER ===== */
const studentCode = localStorage.getItem("studentCode") || "KHÃCH";
const studentName = localStorage.getItem("studentName") || "KhÃ¡ch";

document.getElementById("studentCode").innerText = "MÃ£: " + studentCode;
document.getElementById("studentName").innerText = "ğŸ‘¤ " + studentName;

/* ===== QUESTIONS ===== */
const base = [
 {q:"NgÆ°á»i Ä‘iá»u khiá»ƒn xe mÃ´ tÃ´ pháº£i Ä‘á»§ bao nhiÃªu tuá»•i?",a:["16","18","20","21"],c:1},
 {q:"Biá»ƒn bÃ¡o hÃ¬nh trÃ²n viá»n Ä‘á» lÃ  gÃ¬?",a:["Chá»‰ dáº«n","Cáº¥m","Nguy hiá»ƒm","Cáº£nh bÃ¡o"],c:1}
];
const questions=[];
while(questions.length<30){
  questions.push(JSON.parse(JSON.stringify(base[questions.length%2])));
}

let current=0;
const answers=new Array(30).fill(null);

/* ===== DOM ===== */
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");
const map = document.getElementById("map");
const timeEl = document.getElementById("time");

/* ===== RENDER ===== */
function render(){
 const q=questions[current];
 let html=`<b>CÃ¢u ${current+1}/30:</b> ${q.q}<br><br>`;
 q.a.forEach((x,i)=>{
  html+=`
  <label style="display:block;margin-bottom:8px;">
  <input type="radio" name="ans"
   ${answers[current]==i?'checked':''}
   onchange="answers[${current}]=${i};updateMap()">
  ${x}
  </label>`;
 });
 document.getElementById("questionBox").innerHTML=html;

 prevBtn.style.display=current==0?"none":"inline-block";
 nextBtn.style.display=current==29?"none":"inline-block";
 submitBtn.style.display=current==29?"inline-block":"none";
 updateMap();
}

/* ===== MAP ===== */
function updateMap(){
 map.innerHTML="";
 answers.forEach((a,i)=>{
  let color="#ccc";
  if(i==current) color="#e63946";
  else if(a!==null) color="#457b9d";
  const d=document.createElement("div");
  d.style=`width:30px;height:30px;border-radius:4px;
           background:${color};color:white;
           display:flex;align-items:center;justify-content:center;
           cursor:pointer;font-size:13px;`;
  d.innerText=i+1;
  d.onclick=()=>{current=i;render();}
  map.appendChild(d);
 });
}

/* ===== NAV ===== */
function nextQuestion(){ if(current<29){current++;render();}}
function prevQuestion(){ if(current>0){current--;render();}}

/* ===== TIMER ===== */
let t=30*60;
let submitted=false;
const timer=setInterval(()=>{
 if(submitted) return;
 t--;
 let m=Math.floor(t/60),s=t%60;
 timeEl.innerText=
  String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
 if(t<=0) submitExam();
},1000);

/* ===== SUBMIT ===== */
function submitExam(){
 if(submitted) return;
 submitted=true;
 clearInterval(timer);

 let correct=0;
 questions.forEach((q,i)=>{if(answers[i]==q.c)correct++;});
 const pass=correct>=27;
 const today=new Date().toISOString().split("T")[0];

 db.collection("exam_logs").add({
  code:studentCode,
  score:correct,
  total:30,
  pass:pass,
  date:today,
  timestamp:firebase.firestore.FieldValue.serverTimestamp()
 }).then(()=>{
  alert(`Káº¾T QUáº¢\nÄÃºng: ${correct}/30\n${pass?"âœ… Äáº T":"âŒ KHÃ”NG Äáº T"}`);
  window.location.href="exam.html";
 });
}

render();
</script>
