<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ADMIN ‚Äì CHU·∫®N H√ìA DATABASE</title>

<style>
body{
 font-family:Arial,Helvetica,sans-serif;
 background:#f4f6f8;
 margin:0;
 padding:30px;
}
h1{color:#1d3557;}
.box{
 background:white;
 padding:20px;
 border-radius:12px;
 box-shadow:0 4px 15px rgba(0,0,0,.12);
 max-width:900px;
 margin:auto;
}
button{
 padding:14px 22px;
 border:none;
 border-radius:10px;
 font-size:15px;
 cursor:pointer;
 margin-right:12px;
 color:white;
}
#btnStudent{background:#2a9d8f;}
#btnLog{background:#457b9d;}
#clearBtn{background:#999;}
#log{
 margin-top:20px;
 background:#111;
 color:#0f0;
 padding:15px;
 height:320px;
 overflow:auto;
 font-size:13px;
 border-radius:8px;
}
.count{
 margin-top:15px;
 font-weight:bold;
}
.warn{
 margin-top:10px;
 color:#e63946;
 font-size:14px;
}
</style>
</head>

<body>

<div class="box">
 <h1>üõ† ADMIN ‚Äì CHU·∫®N H√ìA DATABASE</h1>

 <p>
 Trang n√†y d√πng ƒë·ªÉ <b>chu·∫©n h√≥a d·ªØ li·ªáu Firestore</b>.  
 Ch·∫°y xong c√≥ th·ªÉ ƒë√≥ng tab.
 </p>

 <button id="btnStudent">Chu·∫©n h√≥a STUDENTS</button>
 <button id="btnLog">Chu·∫©n h√≥a EXAM_LOGS</button>
 <button id="clearBtn">X√≥a log</button>

 <div class="count" id="count"></div>
 <div id="log"></div>

 <div class="warn">
 ‚ö†Ô∏è Ch·ªâ ADMIN ƒë∆∞·ª£c m·ªü trang n√†y.
 </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
 authDomain:"thi-luat-giao-thong.firebaseapp.com",
 projectId:"thi-luat-giao-thong"
});
const db = firebase.firestore();

const logBox = document.getElementById("log");
const countBox = document.getElementById("count");

function log(msg){
 logBox.innerHTML += msg + "<br>";
 logBox.scrollTop = logBox.scrollHeight;
}

/* ===== CHU·∫®N H√ìA STUDENTS ===== */
document.getElementById("btnStudent").onclick = async ()=>{
 log("‚ñ∂ B·∫ÆT ƒê·∫¶U CHU·∫®N H√ìA STUDENTS...");
 let fixed = 0;

 const snap = await db.collection("students").get();
 for(const doc of snap.docs){
  const d = doc.data();
  let update = {};

  // code ‚Üí string 3 s·ªë
  if(typeof d.code === "number"){
   update.code = String(d.code).padStart(3,"0");
  }
  if(typeof d.code === "string" && d.code.length < 3){
   update.code = d.code.padStart(3,"0");
  }

  // name_lower
  if(d.name && !d.name_lower){
   update.name_lower = d.name.toLowerCase();
  }

  // status
  if(!d.status){
   update.status = "Ho·∫°t ƒë·ªông";
  }

  if(Object.keys(update).length > 0){
   await db.collection("students").doc(doc.id).update(update);
   log(`‚úî Student ${doc.id}: ${JSON.stringify(update)}`);
   fixed++;
  }
 }

 countBox.innerText = `‚úÖ STUDENTS ƒë√£ chu·∫©n h√≥a: ${fixed}`;
 log("üéâ HO√ÄN T·∫§T STUDENTS");
};

/* ===== CHU·∫®N H√ìA EXAM_LOGS ===== */
document.getElementById("btnLog").onclick = async ()=>{
 log("‚ñ∂ B·∫ÆT ƒê·∫¶U CHU·∫®N H√ìA EXAM_LOGS...");
 let fixed = 0;

 const snap = await db.collection("exam_logs").get();
 for(const doc of snap.docs){
  const d = doc.data();
  let update = {};

  if(typeof d.code === "number"){
   update.code = String(d.code).padStart(3,"0");
  }
  if(typeof d.code === "string" && d.code.length < 3){
   update.code = d.code.padStart(3,"0");
  }

  if(Object.keys(update).length > 0){
   await db.collection("exam_logs").doc(doc.id).update(update);
   log(`‚úî Log ${doc.id}: ${JSON.stringify(update)}`);
   fixed++;
  }
 }

 countBox.innerText = `‚úÖ EXAM_LOGS ƒë√£ chu·∫©n h√≥a: ${fixed}`;
 log("üéâ HO√ÄN T·∫§T EXAM_LOGS");
};

/* ===== CLEAR LOG ===== */
document.getElementById("clearBtn").onclick = ()=>{
 logBox.innerHTML="";
 countBox.innerText="";
};
</script>

</body>
</html>
