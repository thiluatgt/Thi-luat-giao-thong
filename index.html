<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Há»† THá»NG KIá»‚M TRA LUáº¬T GIAO THÃ”NG ÄÆ¯á»œNG Bá»˜</title>

<style>
body{
 margin:0;
 font-family:Arial;
 min-height:100vh;
 background:
 linear-gradient(rgba(0,0,0,.55),rgba(0,0,0,.55)),
 url("https://images.unsplash.com/photo-1604138845907-7aa04f0f9950?auto=format&fit=crop&w=1600&q=80");
 background-size:cover;
 background-position:center;
 display:flex;
 align-items:center;
 justify-content:center;
}
#loginBox{
 width:460px;
 background:rgba(255,255,255,.96);
 padding:30px;
 border-radius:14px;
 box-shadow:0 15px 40px rgba(0,0,0,.35);
}
h2{text-align:center;color:#1d3557;line-height:1.4;}
input{
 width:100%;
 padding:14px;
 font-size:16px;
 margin-top:16px;
 border-radius:8px;
 border:1px solid #ccc;
}
button{
 width:100%;
 padding:14px;
 font-size:17px;
 border:none;
 border-radius:10px;
 cursor:pointer;
 margin-top:16px;
}
#loginBtn{background:#1d3557;color:white;}
#guestBtn{background:#457b9d;color:white;}
.note{
 margin-top:22px;
 font-size:14px;
 color:#444;
 text-align:center;
 line-height:1.6;
}
</style>
</head>

<body>

<div id="loginBox">
 <h2>
  Há»† THá»NG KIá»‚M TRA<br>
  LUáº¬T GIAO THÃ”NG ÄÆ¯á»œNG Bá»˜
 </h2>

 <input id="inputLogin" type="text"
  placeholder="Nháº­p mÃ£ HV hoáº·c tÃªn há»c viÃªn (VD: HV001, 001, Nguyá»…n VÄƒn A, VÄƒn A...)">

 <button id="loginBtn">ğŸ” ÄÄ‚NG NHáº¬P Há»† THá»NG</button>
 <button id="guestBtn">ğŸ§ª THI THá»¬ KHÃ”NG Cáº¦N ÄÄ‚NG NHáº¬P</button>

 <div class="note">
  Báº¡n chÆ°a cÃ³ mÃ£ há»c viÃªn?<br>
  Báº¡n cÃ³ thá»ƒ <b>thi thá»­</b> Ä‘á»ƒ tráº£i nghiá»‡m.<br>
  LiÃªn há»‡ quáº£n trá»‹ viÃªn Ä‘á»ƒ sá»­ dá»¥ng Ä‘áº§y Ä‘á»§ chá»©c nÄƒng.
 </div>
</div>

<!-- ===== FIREBASE ===== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
 authDomain:"thi-luat-giao-thong.firebaseapp.com",
 projectId:"thi-luat-giao-thong"
});
const db=firebase.firestore();

const input=document.getElementById("inputLogin");
const loginBtn=document.getElementById("loginBtn");

/* ===== ENTER KEY ===== */
input.addEventListener("keydown",e=>{
 if(e.key==="Enter") login();
});
loginBtn.onclick=login;

/* ===== FORMAT CODE ===== */
function normalizeCode(v){
 v=v.toUpperCase().replace("HV","");
 if(isNaN(v)) return null;
 v=v.padStart(3,"0");
 return "HV"+v;
}

/* ===== LOGIN ===== */
function login(){
 const raw=input.value.trim();
 if(!raw){alert("Vui lÃ²ng nháº­p thÃ´ng tin Ä‘Äƒng nháº­p");return;}

 const tryCode=normalizeCode(raw);

 /* ==== 1. THá»¬ ÄÄ‚NG NHáº¬P Báº°NG MÃƒ HV ==== */
 if(tryCode){
  db.collection("students").where("code","==",tryCode).get()
  .then(snap=>{
   if(!snap.empty){
    loginSuccess(snap.docs[0].data());
   }else{
    loginByName(raw);
   }
  });
 }else{
  loginByName(raw);
 }
}

/* ===== LOGIN BY NAME ===== */
function loginByName(nameInput){
 const keyword=nameInput.toLowerCase();

 db.collection("students").get().then(snap=>{
  let found=null;
  snap.forEach(doc=>{
   const s=doc.data();
   const name=s.name.toLowerCase();
   if(name.includes(keyword)){
    found=s;
   }
  });

  if(!found){
   alert("âŒ KhÃ´ng tÃ¬m tháº¥y há»c viÃªn phÃ¹ há»£p");
   return;
  }
  loginSuccess(found);
 });
}

/* ===== SUCCESS ===== */
function loginSuccess(s){
 localStorage.setItem("userType","student");
 localStorage.setItem("studentCode",s.code);
 localStorage.setItem("studentName",s.name);
 localStorage.setItem("unit",s.unit||"");
 window.location.href="exam.html";
}

/* ===== GUEST ===== */
guestBtn.onclick=()=>{
 localStorage.clear();
 localStorage.setItem("userType","guest");
 localStorage.setItem("studentName","KhÃ¡ch");
 window.location.href="exam.html";
};
</script>

</body>
</html>
