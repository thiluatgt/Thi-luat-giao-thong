<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Trang há»c viÃªn</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h2>TRANG Há»ŒC VIÃŠN</h2>

<div style="border:1px solid #999;padding:15px;margin-bottom:20px;background:#f9f9f9;">
  <h3>ğŸ“˜ ThÃ´ng tin bÃ i kiá»ƒm tra</h3>
  <ul>
    <li>Sá»‘ cÃ¢u há»i: <b>30 cÃ¢u</b></li>
    <li>Thá»i gian lÃ m bÃ i: <b>30 phÃºt</b></li>
    <li>Káº¿t quáº£ Ä‘áº¡t khi <b>cÃ³ tá»« 27/30 cÃ¢u Ä‘Ãºng</b></li>
    <li>Má»—i cÃ¢u chá»‰ chá»n <b>1 Ä‘Ã¡p Ã¡n</b></li>
  </ul>

  <h3>âš ï¸ Quy Ä‘á»‹nh & chá»‘ng gian láº­n</h3>
  <ul>
    <li>KhÃ´ng má»Ÿ nhiá»u tab trÃ¬nh duyá»‡t</li>
    <li>KhÃ´ng reload trang khi Ä‘ang lÃ m bÃ i</li>
    <li>Há»‡ thá»‘ng tá»± Ä‘á»™ng ghi nháº­n thá»i gian</li>
    <li>Há»c viÃªn cÃ³ thá»ƒ bá»‹ khÃ³a náº¿u vi pháº¡m</li>
  </ul>
</div>

<div id="studentInfo" style="border:1px solid #ccc;padding:15px;margin-bottom:20px;">
  <p><b>MÃ£ há»c viÃªn:</b> <span id="infoCode"></span></p>
  <p><b>TÃªn há»c viÃªn:</b> <span id="infoName"></span></p>
  <p><b>Tráº¡ng thÃ¡i:</b> <span id="infoStatus"></span></p>
</div>

<button onclick="startExam()" style="font-size:18px;padding:12px 20px;background:green;color:white;border:none;border-radius:5px;">
  â–¶ TIáº¾P Tá»¤C KIá»‚M TRA
</button>

<br><br>

<button onclick="logout()">ÄÄƒng xuáº¥t</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================== FIREBASE ================== */
const firebaseConfig = {
  apiKey: "AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
  authDomain: "thi-luat-giao-thong.firebaseapp.com",
  projectId: "thi-luat-giao-thong",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================== LOGIN CHECK ================== */
const studentCode = localStorage.getItem("studentCode");
const userType = localStorage.getItem("userType");

if (!studentCode || userType !== "student") {
  alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p");
  window.location.href = "index.html";
  return;
}

/* ================== LOAD STUDENT ================== */
db.collection("students")
  .where("code", "==", studentCode)
  .get()
  .then(snapshot => {
    if (snapshot.empty) {
      alert("KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin há»c viÃªn");
      return;
    }

    const student = snapshot.docs[0].data();
    document.getElementById("infoCode").innerText = student.code;
    document.getElementById("infoName").innerText = student.name;
    document.getElementById("infoStatus").innerText = student.status;
  });

/* ================== EXAM LIMIT ================== */
const MAX_EXAM_PER_DAY = 3;

function getToday() {
  return new Date().toISOString().split("T")[0];
}

function startExam() {
  const today = getToday();

  db.collection("exam_logs")
    .where("code", "==", studentCode)
    .where("date", "==", today)
    .get()
    .then(snapshot => {
      if (snapshot.size >= MAX_EXAM_PER_DAY) {
        alert("âŒ Báº¡n Ä‘Ã£ vÆ°á»£t quÃ¡ sá»‘ lÆ°á»£t kiá»ƒm tra trong ngÃ y");
        return;
      }

      db.collection("exam_logs").add({
        code: studentCode,
        date: today,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert("âœ… Báº¯t Ä‘áº§u lÃ m bÃ i kiá»ƒm tra");
        window.location.href = "test.html";
      });
    });
}

/* ================== LOGOUT ================== */
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}
</script>

</body>
</html>
