<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Há»† THá»NG KIá»‚M TRA LUáº¬T GIAO THÃ”NG ÄÆ¯á»œNG Bá»˜</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 margin:0;
 font-family:Arial,Helvetica,sans-serif;
 background:#eef2f6;
}
header{
 background:#1d3557;
 color:white;
 padding:18px 30px;
 display:flex;
 justify-content:space-between;
 align-items:center;
}
#logoutBtn{
 background:#e63946;
 color:white;
 border:none;
 border-radius:8px;
 padding:10px 16px;
 cursor:pointer;
}
#container{
 max-width:1200px;
 margin:30px auto;
 padding:0 20px;
}
#welcome{
 font-size:22px;
 margin-bottom:25px;
 color:#1d3557;
}
.grid{
 display:grid;
 grid-template-columns:1fr 2.2fr;
 gap:25px;
}
.box{
 background:white;
 padding:20px;
 border-radius:14px;
 box-shadow:0 4px 15px rgba(0,0,0,.12);
}
.box h3{
 margin-top:0;
 color:#1d3557;
}
.info p{margin:8px 0;}

.statRow{
 display:flex;
 gap:15px;
 margin-bottom:15px;
}
.statBox{
 flex:1;
 text-align:center;
 padding:15px;
 border-radius:10px;
 color:white;
}
.statBox b{font-size:22px;}
.bg1{background:#457b9d;}
.bg2{background:#2a9d8f;}
.bg3{background:#e63946;}

.tableWrap{margin-top:15px;}
table{
 width:100%;
 border-collapse:collapse;
 font-size:14px;
}
th,td{
 padding:10px;
 text-align:center;
 border-bottom:1px solid #eee;
}
th{
 background:#f1f4fb;
 color:#1d3557;
}
.pass{color:#2a9d8f;font-weight:bold;}
.fail{color:#e63946;font-weight:bold;}

canvas{
 width:100%!important;
 height:240px!important;
 margin-top:15px;
}

.actions{
 display:flex;
 justify-content:flex-end;
 gap:14px;
 margin-top:15px;
}
.actionBtn{
 border:none;
 border-radius:10px;
 padding:14px 20px;
 font-size:15px;
 cursor:pointer;
 min-width:200px;
 color:white;
}
#detailBtn{background:#457b9d;}
#startBtn{background:#2a9d8f;}
</style>
</head>

<body>

<header>
 <b>Há»† THá»NG KIá»‚M TRA LUáº¬T GIAO THÃ”NG</b>
 <button id="logoutBtn">ÄÄƒng xuáº¥t</button>
</header>

<div id="container">

 <div id="welcome">
  Xin chÃ o, <b id="studentName"></b> ğŸ‘‹
 </div>

 <div class="grid">

  <div class="box info">
   <h3>ğŸ“˜ ThÃ´ng tin há»c viÃªn</h3>
   <p><b>MÃ£ há»c viÃªn:</b> <span id="infoCode"></span></p>
   <p><b>Há» vÃ  tÃªn:</b> <span id="infoName"></span></p>
   <p><b>ÄÆ¡n vá»‹:</b> <span id="infoUnit"></span></p>
   <p><b>Tráº¡ng thÃ¡i:</b> Hoáº¡t Ä‘á»™ng</p>
  </div>

  <div class="box">
   <h3>ğŸ“Š Thá»‘ng kÃª káº¿t quáº£</h3>

   <div class="statRow">
    <div class="statBox bg1">Tá»•ng lÆ°á»£t<br><b id="totalExam">0</b></div>
    <div class="statBox bg2">Äáº¡t<br><b id="passExam">0</b></div>
    <div class="statBox bg3">KhÃ´ng Ä‘áº¡t<br><b id="failExam">0</b></div>
   </div>

   <canvas id="chart"></canvas>

   <div class="tableWrap">
    <table>
     <thead>
      <tr>
       <th>#</th>
       <th>Thá»i gian</th>
       <th>Káº¿t quáº£</th>
      </tr>
     </thead>
     <tbody id="logTable"></tbody>
    </table>
   </div>

   <div class="actions">
    <button id="detailBtn" class="actionBtn">ğŸ“„ Thá»‘ng kÃª chi tiáº¿t</button>
    <button id="startBtn" class="actionBtn">â–¶ LÃ m bÃ i kiá»ƒm tra</button>
   </div>

  </div>

 </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
 apiKey:"AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
 authDomain:"thi-luat-giao-thong.firebaseapp.com",
 projectId:"thi-luat-giao-thong"
});
const db = firebase.firestore();

/* ===== LOGIN CHECK ===== */
if(localStorage.getItem("userType") !== "student"){
 alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p");
 location.href = "index.html";
}

/* ===== USER DATA ===== */
const code = localStorage.getItem("studentCode");
const name = localStorage.getItem("studentName");
const unit = localStorage.getItem("unit") || "";

if(!code || !name){
 alert("PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n");
 location.href = "index.html";
}

/* ===== DOM ===== */
const el = id => document.getElementById(id);
el("studentName").innerText = name;
el("infoCode").innerText = code;
el("infoName").innerText = name;
el("infoUnit").innerText = unit;

/* ===== CHART ===== */
let pieChart = null;

function drawChart(pass, fail){
 if(pieChart) pieChart.destroy();
 pieChart = new Chart(el("chart"),{
  type:"pie",
  data:{
   labels:["Äáº¡t","KhÃ´ng Ä‘áº¡t"],
   datasets:[{
    data:[pass,fail],
    backgroundColor:["#2a9d8f","#e63946"]
   }]
  },
  options:{responsive:true,maintainAspectRatio:false}
 });
}

/* ===== LOAD DATA ===== */
db.collection("exam_logs")
 .where("code","==",code)
 .orderBy("timestamp","desc")
 .get()
 .then(snap=>{
  let total=0, pass=0, fail=0;
  el("logTable").innerHTML="";

  let i=1;
  snap.forEach(doc=>{
   const d = doc.data();
   total++;
   d.pass ? pass++ : fail++;

   const time = d.timestamp
    ? new Date(d.timestamp.seconds*1000).toLocaleString("vi-VN")
    : "";

   el("logTable").insertAdjacentHTML("beforeend",`
    <tr>
     <td>${i++}</td>
     <td>${time}</td>
     <td class="${d.pass?'pass':'fail'}">
      ${d.pass?'Äáº T':'KHÃ”NG Äáº T'}
     </td>
    </tr>
   `);
  });

  el("totalExam").innerText = total;
  el("passExam").innerText = pass;
  el("failExam").innerText = fail;

  drawChart(pass, fail);
 })
 .catch(err=>{
  console.error(err);
  alert("KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u thá»‘ng kÃª");
 });

/* ===== ACTIONS ===== */
el("logoutBtn").onclick = ()=>{
 localStorage.clear();
 location.href="index.html";
};
el("startBtn").onclick = ()=>location.href="test.html";
el("detailBtn").onclick = ()=>location.href="exam_detail.html";
</script>

</body>
</html>
