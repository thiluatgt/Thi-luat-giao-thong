<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>H·ªÜ TH·ªêNG KI·ªÇM TRA LU·∫¨T GIAO TH√îNG ƒê∆Ø·ªúNG B·ªò</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#eef2f6;}
header{
 background:#1d3557;color:white;
 padding:18px 30px;
 display:flex;justify-content:space-between;align-items:center;
}
#logoutBtn{
 background:#e63946;color:white;border:none;
 border-radius:8px;padding:10px 16px;cursor:pointer;
}
#container{max-width:1200px;margin:30px auto;padding:0 20px;}
#welcome{font-size:22px;margin-bottom:25px;color:#1d3557;}
.grid{display:grid;grid-template-columns:1fr 2.2fr;gap:25px;}
.box{
 background:white;padding:20px;border-radius:14px;
 box-shadow:0 4px 15px rgba(0,0,0,.12);
}
.box h3{margin-top:0;color:#1d3557;}
.info p{margin:8px 0;}
.statRow{display:flex;gap:15px;margin-bottom:15px;}
.statBox{
 flex:1;text-align:center;padding:15px;border-radius:10px;color:white;
}
.statBox b{font-size:22px;}
.bg1{background:#457b9d;}
.bg2{background:#2a9d8f;}
.bg3{background:#e63946;}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:15px;}
th,td{padding:10px;text-align:center;border-bottom:1px solid #eee;}
th{background:#f1f4fb;color:#1d3557;}
.pass{color:#2a9d8f;font-weight:bold;}
.fail{color:#e63946;font-weight:bold;}
canvas{width:100%!important;height:240px!important;margin-top:15px;}
.actions{display:flex;justify-content:flex-end;gap:14px;margin-top:15px;}
.actionBtn{
 border:none;border-radius:10px;padding:14px 20px;
 font-size:15px;cursor:pointer;min-width:200px;color:white;
}
#detailBtn{background:#457b9d;}
#startBtn{background:#2a9d8f;}
#empty{color:#888;text-align:center;margin-top:15px;}
</style>
</head>

<body>

<header>
 <b>H·ªÜ TH·ªêNG KI·ªÇM TRA LU·∫¨T GIAO TH√îNG</b>
 <button id="logoutBtn">ƒêƒÉng xu·∫•t</button>
</header>

<div id="container">

 <div id="welcome">
  Xin ch√†o, <b id="studentName">...</b> üëã
 </div>

 <div class="grid">

  <div class="box info">
   <h3>üìò Th√¥ng tin h·ªçc vi√™n</h3>
   <p><b>M√£ h·ªçc vi√™n:</b> <span id="infoCode"></span></p>
   <p><b>H·ªç v√† t√™n:</b> <span id="infoName"></span></p>
   <p><b>ƒê∆°n v·ªã:</b> <span id="infoUnit"></span></p>
   <p><b>Tr·∫°ng th√°i:</b> <span id="infoStatus"></span></p>
  </div>

  <div class="box">
   <h3>üìä Th·ªëng k√™ k·∫øt qu·∫£</h3>

   <div class="statRow">
    <div class="statBox bg1">T·ªïng l∆∞·ª£t<br><b id="totalExam">0</b></div>
    <div class="statBox bg2">ƒê·∫°t<br><b id="passExam">0</b></div>
    <div class="statBox bg3">Kh√¥ng ƒë·∫°t<br><b id="failExam">0</b></div>
   </div>

   <canvas id="chart"></canvas>
   <div id="empty"></div>

   <table>
    <thead>
     <tr>
      <th>#</th>
      <th>Th·ªùi gian</th>
      <th>K·∫øt qu·∫£</th>
     </tr>
    </thead>
    <tbody id="logTable"></tbody>
   </table>

   <div class="actions">
    <button id="detailBtn" class="actionBtn">üìÑ Th·ªëng k√™ chi ti·∫øt</button>
    <button id="startBtn" class="actionBtn">‚ñ∂ L√†m b√†i ki·ªÉm tra</button>
   </div>

  </div>

 </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
 apiKey:"AIzaSyBGivIEsyBLsLs0CqRvwmwceG26duZbWlM",
 authDomain:"thi-luat-giao-thong.firebaseapp.com",
 projectId:"thi-luat-giao-thong"
});
const db=firebase.firestore();

/* ===== LOGIN CHECK ===== */
if(localStorage.getItem("userType")!=="student"){
 location.href="index.html";
}

/* ===== GET LOGIN VALUE ===== */
const rawInput = localStorage.getItem("studentCode") || "";
const inputNumber = rawInput.replace(/\D/g,""); // ch·ªâ l·∫•y s·ªë

/* ===== LOAD STUDENT (SAFE MODE) ===== */
<script>
/* ===== L·∫§Y GI√Å TR·ªä ƒêƒÇNG NH·∫¨P ===== */
const rawInput = (localStorage.getItem("studentCode") || "").trim();
const inputNumber = rawInput.replace(/\D/g, ""); // ch·ªâ l·∫•y s·ªë

if(!inputNumber){
 alert("D·ªØ li·ªáu ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá");
 location.href = "index.html";
}

/* ===== T√åM H·ªåC VI√äN (CH·ªêNG L·ªñI) ===== */
db.collection("students").get().then(snapshot => {
 let student = null;

 snapshot.forEach(doc => {
  const s = doc.data();

  if(!s.code) return;

  const dbNumber = String(s.code).replace(/\D/g, "");

  if(dbNumber === inputNumber){
   student = s;
  }
 });

 if(!student){
  alert("‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin h·ªçc vi√™n");
  location.href = "index.html";
  return;
 }

 /* ===== HI·ªÇN TH·ªä TH√îNG TIN ===== */
 studentName.innerText = student.name;
 infoCode.innerText = "HV" + String(student.code).replace(/\D/g,"");
 infoName.innerText = student.name;
 infoUnit.innerText = student.unit || "";
 infoStatus.innerText = student.status || "Ho·∫°t ƒë·ªông";

 /* ===== LOAD LOG THI ===== */
 loadExamLogs(String(student.code).replace(/\D/g,""));
});
</script>

 if(!found){
  alert("‚ùå Kh√¥ng t√¨m th·∫•y h·ªçc vi√™n trong h·ªá th·ªëng");
  location.href="index.html";
  return;
 }

 /* ===== SHOW INFO ===== */
 studentName.innerText=found.name;
 infoCode.innerText="HV"+String(found.code).replace(/\D/g,"");
 infoName.innerText=found.name;
 infoUnit.innerText=found.unit||"";
 infoStatus.innerText=found.status||"Ho·∫°t ƒë·ªông";

 loadExamLogs(String(found.code).replace(/\D/g,""));
});

/* ===== LOAD EXAM LOGS ===== */
function loadExamLogs(code){
 db.collection("exam_logs")
 .where("code","==",code)
 .get()
 .then(snap=>{
  let logs=[];
  snap.forEach(doc=>logs.push(doc.data()));

  if(logs.length===0){
   empty.innerText="üì≠ Ch∆∞a c√≥ d·ªØ li·ªáu thi";
   return;
  }

  logs.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));

  let total=0,pass=0,fail=0;
  logTable.innerHTML="";

  logs.forEach((d,i)=>{
   total++;
   d.pass?pass++:fail++;

   const time=d.timestamp
    ? new Date(d.timestamp.seconds*1000).toLocaleString("vi-VN")
    : "-";

   logTable.innerHTML+=`
    <tr>
     <td>${i+1}</td>
     <td>${time}</td>
     <td class="${d.pass?'pass':'fail'}">
      ${d.pass?'ƒê·∫†T':'KH√îNG ƒê·∫†T'}
     </td>
    </tr>`;
  });

  totalExam.innerText=total;
  passExam.innerText=pass;
  failExam.innerText=fail;
  drawChart(pass,fail);
 });
}

/* ===== CHART ===== */
let chart=null;
function drawChart(pass,fail){
 if(chart) chart.destroy();
 chart=new Chart(chart,{
  type:"pie",
  data:{
   labels:["ƒê·∫°t","Kh√¥ng ƒë·∫°t"],
   datasets:[{
    data:[pass,fail],
    backgroundColor:["#2a9d8f","#e63946"]
   }]
  },
  options:{responsive:true,maintainAspectRatio:false}
 });
}

/* ===== ACTIONS ===== */
logoutBtn.onclick=()=>{
 localStorage.clear();
 location.href="index.html";
};
startBtn.onclick=()=>location.href="test.html";
detailBtn.onclick=()=>location.href="exam_detail.html";
</script>

</body>
</html>
